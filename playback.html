<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playback</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
            overscroll-behavior: none;
        }

        .container {
            background: #000000;
            width: 100%;
            max-width: 430px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .mode-selector {
            padding: 16px 30px 12px 30px;
            background: #000000;
            flex-shrink: 0;
            border-bottom: 1px solid #2c2c2e;
        }

        .mode-selector.hidden {
            display: none;
        }

        .mode-tabs {
            display: flex;
            background: #1c1c1e;
            border-radius: 10px;
            padding: 2px;
            gap: 2px;
        }

        .mode-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-tab.active {
            background: #2c2c2e;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .upload-section {
            padding: 20px 30px 12px 30px;
            text-align: center;
            background: #000000;
            flex-shrink: 0;
        }

        .upload-section.hidden {
            display: none;
        }

        .upload-section.has-song {
            padding: 12px 30px;
        }

        .youtube-input-container {
            display: none !important;
        }

        .youtube-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 12px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .youtube-input:focus {
            border-color: #007AFF;
        }

        .load-video-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s ease;
            width: 100%;
        }

        .load-video-btn:active {
            opacity: 0.7;
        }

        .upload-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s ease;
            display: inline-block;
        }

        .upload-btn:active {
            opacity: 0.7;
        }

        .upload-btn.hidden {
            display: none;
        }

        input[type="file"] {
            display: none;
        }

        .song-info {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .song-info.active {
            display: flex;
        }

        .album-art {
            width: 100px;
            height: 100px;
            background: #1c1c1e;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .album-art .placeholder {
            font-size: 36px;
            color: #48484a;
        }

        .song-details {
            text-align: center;
            width: 100%;
        }

        .song-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
            color: #ffffff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-artist {
            font-size: 13px;
            color: #98989d;
        }

        .player-section {
            padding: 12px 30px;
            flex-shrink: 0;
            background: #000000;
        }

        .youtube-player-wrapper {
            display: none;
            flex-shrink: 0;
        }

        .youtube-player-wrapper.active {
            display: flex;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            left: 80px;
            background: #000000;
            align-items: center;
            justify-content: center;
        }

        #youtube-player {
            height: 100vh;
            width: calc(100vh * 16 / 9);
            max-width: 100%;
        }

        .youtube-controls-section {
            display: none;
            flex-shrink: 0;
        }

        .youtube-controls-section.active {
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            width: 80px;
            height: 100vh;
            padding: 12px 8px;
            background: #000000;
            gap: 8px;
        }

        .youtube-add-chapter-minimal {
            background: #007AFF;
            color: white;
            border: none;
            width: 64px;
            height: 28px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s ease;
            flex-shrink: 0;
        }

        .youtube-add-chapter-minimal:active {
            opacity: 0.5;
        }

        .youtube-add-chapter-minimal:disabled {
            opacity: 0.3;
        }

        .youtube-url-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .youtube-url-popup.active {
            display: flex;
        }

        .youtube-url-popup-content {
            background: #1c1c1e;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .youtube-url-popup-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 16px;
            text-align: center;
        }

        .youtube-url-popup-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #2c2c2e;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 16px;
            outline: none;
            transition: border-color 0.2s ease;
            background: #000000;
            color: #ffffff;
        }

        .youtube-url-popup-input:focus {
            border-color: #007AFF;
        }

        .youtube-url-popup-buttons {
            display: flex;
            gap: 12px;
        }

        .youtube-url-popup-btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .youtube-url-popup-btn:active {
            opacity: 0.7;
        }

        .youtube-url-popup-btn.cancel {
            background: #2c2c2e;
            color: #ffffff;
        }

        .youtube-url-popup-btn.load {
            background: #007AFF;
            color: white;
        }

        .youtube-time-btn {
            background: #1c1c1e;
            border: none;
            width: 64px;
            height: 32px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #007AFF;
            cursor: pointer;
            transition: opacity 0.2s ease;
            flex-shrink: 0;
        }

        .youtube-time-btn:active {
            opacity: 0.5;
        }

        .youtube-time-controls {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: center;
        }

        .youtube-chapters-minimal {
            display: flex;
            flex-direction: column;
            gap: 3px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            min-height: 0;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .youtube-chapter-minimal {
            background: #1c1c1e;
            border: none;
            width: 64px;
            min-height: 28px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            color: #ffffff;
            cursor: pointer;
            transition: opacity 0.2s ease;
            padding: 4px 6px;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .youtube-chapter-minimal:active {
            opacity: 0.5;
        }

        .youtube-chapter-delete-minimal {
            position: absolute;
            top: 2px;
            right: 2px;
            background: transparent;
            color: #007AFF;
            border: none;
            width: 14px;
            height: 14px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .youtube-chapter-delete-minimal:active {
            opacity: 0.5;
        }

        .youtube-chapter-number-minimal {
            font-size: 9px;
            color: #98989d;
        }

        .progress-container {
            margin-bottom: 16px;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #98989d;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #2c2c2e;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            -webkit-appearance: none;
            appearance: none;
            outline: none;
        }

        .progress-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 0;
            height: 0;
            opacity: 0;
        }

        .progress-bar::-moz-range-thumb {
            width: 0;
            height: 0;
            border: none;
            opacity: 0;
        }

        .progress-bar::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, #007AFF 0%, #007AFF var(--progress, 0%), #2c2c2e var(--progress, 0%), #2c2c2e 100%);
            border-radius: 2px;
        }

        .progress-bar::-moz-range-track {
            width: 100%;
            height: 4px;
            background: #2c2c2e;
            border-radius: 2px;
        }

        .progress-bar::-moz-range-progress {
            height: 4px;
            background: #007AFF;
            border-radius: 2px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .control-btn {
            background: transparent;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: #007AFF;
            transition: opacity 0.2s ease;
        }

        .control-btn:active {
            opacity: 0.4;
        }

        .control-btn.play-pause {
            width: 64px;
            height: 64px;
            background: transparent;
            color: #007AFF;
        }

        .control-btn.play-pause svg {
            width: 28px;
            height: 28px;
            fill: #007AFF;
        }

        .chapters-section {
            border-top: 1px solid #2c2c2e;
            padding: 16px 30px 0 30px;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .youtube-controls-section.active .chapters-section {
            border-top: 1px solid #2c2c2e;
            padding: 16px 0 0 0;
            margin-top: 20px;
        }

        .chapters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .chapters-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .add-chapter-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .add-chapter-btn:active {
            opacity: 0.7;
        }

        .add-chapter-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .chapters-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 80px;
            overscroll-behavior: contain;
        }

        .empty-chapters {
            text-align: center;
            padding: 40px 20px;
            color: #98989d;
            font-size: 15px;
        }

        .chapter-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: #1c1c1e;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .chapter-item:active {
            background: #2c2c2e;
        }

        .chapter-number {
            width: 28px;
            height: 28px;
            background: #007AFF;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .chapter-time {
            font-size: 15px;
            font-weight: 500;
            color: #ffffff;
            font-variant-numeric: tabular-nums;
        }

        .delete-btn {
            margin-left: auto;
            background: transparent;
            color: #007AFF;
            border: none;
            width: 28px;
            height: 28px;
            font-size: 24px;
            font-weight: 400;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease;
            flex-shrink: 0;
            line-height: 1;
        }

        .delete-btn:active {
            opacity: 0.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mode Selector -->
        <div class="mode-selector" id="modeSelector">
            <div class="mode-tabs">
                <button class="mode-tab active" id="audioTab">Audio File</button>
                <button class="mode-tab" id="youtubeTab">YouTube</button>
            </div>
        </div>

        <!-- Audio Upload Section -->
        <div class="upload-section" id="uploadSection">
            <label for="fileInput" class="upload-btn" id="uploadBtn">Choose Audio File</label>
            <input type="file" id="fileInput" accept="audio/*">
            
            <div class="song-info" id="songInfo">
                <div class="album-art" id="albumArt">
                    <span class="placeholder">ðŸŽµ</span>
                </div>
                <div class="song-details">
                    <div class="song-title" id="songTitle">Song Title</div>
                    <div class="song-artist" id="songArtist">Artist</div>
                </div>
            </div>
        </div>

        <!-- YouTube Input Section -->
        <div class="youtube-input-container" id="youtubeInputContainer">
            <input 
                type="text" 
                class="youtube-input" 
                id="youtubeInput" 
                placeholder="Paste YouTube URL here..."
            >
            <button class="load-video-btn" id="loadVideoBtn">Load Video</button>
        </div>

        <!-- Audio Player Section -->
        <div class="player-section" id="playerSection">
            <audio id="audioPlayer"></audio>
            
            <div class="progress-container">
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
                <input type="range" class="progress-bar" id="progressBar" min="0" max="100" value="0">
            </div>

            <div class="controls">
                <button class="control-btn" id="back1">-1s</button>
                <button class="control-btn play-pause" id="playPause">
                    <svg id="playIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg id="pauseIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                    </svg>
                </button>
                <button class="control-btn" id="skip1">+1s</button>
            </div>
        </div>

        <!-- YouTube Player Wrapper -->
        <div class="youtube-player-wrapper" id="youtubePlayerWrapper">
            <div id="youtube-player"></div>
        </div>

        <!-- YouTube Controls Section -->
        <div class="youtube-controls-section" id="youtubeControlsSection">
            <!-- Time Controls -->
            <div class="youtube-time-controls">
                <button class="youtube-time-btn" id="youtubeSkip1">+1s</button>
                <button class="youtube-time-btn" id="youtubeBack1">-1s</button>
            </div>

            <!-- Add Chapter Button -->
            <button class="youtube-add-chapter-minimal" id="youtubeAddChapterBtn" disabled>+ Add</button>

            <!-- Chapters List -->
            <div class="youtube-chapters-minimal" id="youtubeChaptersList"></div>
        </div>

        <!-- Chapters Section -->
        <div class="chapters-section" id="audioChaptersSection">
            <div class="chapters-header">
                <div class="chapters-title">Chapters</div>
                <button class="add-chapter-btn" id="addChapterBtn" disabled>+ Add</button>
            </div>
            <div class="chapters-list" id="chaptersList">
                <div class="empty-chapters">No chapters yet. Add a chapter at the current time!</div>
            </div>
        </div>
    </div>

    <!-- YouTube URL Popup -->
    <div class="youtube-url-popup" id="youtubeUrlPopup">
        <div class="youtube-url-popup-content">
            <div class="youtube-url-popup-title">Enter YouTube URL</div>
            <input 
                type="text" 
                class="youtube-url-popup-input" 
                id="youtubePopupInput" 
                placeholder="Paste YouTube link here..."
            >
            <div class="youtube-url-popup-buttons">
                <button class="youtube-url-popup-btn cancel" id="popupCancelBtn">Cancel</button>
                <button class="youtube-url-popup-btn load" id="popupLoadBtn">Load</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const modeSelector = document.getElementById('modeSelector');
        const audioTab = document.getElementById('audioTab');
        const youtubeTab = document.getElementById('youtubeTab');
        const uploadSection = document.getElementById('uploadSection');
        const youtubeInputContainer = document.getElementById('youtubeInputContainer');
        const playerSection = document.getElementById('playerSection');
        const youtubePlayerWrapper = document.getElementById('youtubePlayerWrapper');
        const youtubeControlsSection = document.getElementById('youtubeControlsSection');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const songInfo = document.getElementById('songInfo');
        const songTitle = document.getElementById('songTitle');
        const songArtist = document.getElementById('songArtist');
        const albumArt = document.getElementById('albumArt');
        const audioPlayer = document.getElementById('audioPlayer');
        const playPause = document.getElementById('playPause');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const progressBar = document.getElementById('progressBar');
        const currentTime = document.getElementById('currentTime');
        const totalTime = document.getElementById('totalTime');
        const addChapterBtn = document.getElementById('addChapterBtn');
        const chaptersList = document.getElementById('chaptersList');
        const audioChaptersSection = document.getElementById('audioChaptersSection');
        
        // YouTube Elements
        const youtubeInput = document.getElementById('youtubeInput');
        const loadVideoBtn = document.getElementById('loadVideoBtn');
        const youtubeUrlPopup = document.getElementById('youtubeUrlPopup');
        const youtubePopupInput = document.getElementById('youtubePopupInput');
        const popupCancelBtn = document.getElementById('popupCancelBtn');
        const popupLoadBtn = document.getElementById('popupLoadBtn');

        // State
        let chapters = [];
        let isPlaying = false;
        let isSeeking = false;
        let currentSongKey = null;
        let currentMode = 'audio'; // 'audio' or 'youtube'
        
        // YouTube Player
        let ytPlayer = null;

        // Get appropriate chapter elements based on mode
        function getChapterElements() {
            if (currentMode === 'youtube') {
                return {
                    addBtn: document.getElementById('youtubeAddChapterBtn'),
                    list: document.getElementById('youtubeChaptersList')
                };
            } else {
                return {
                    addBtn: addChapterBtn,
                    list: chaptersList
                };
            }
        }

        // Initialize UI state on page load
        function initializeUI() {
            // Show mode selector
            modeSelector.classList.remove('hidden');
            
            // Hide popup
            youtubeUrlPopup.classList.remove('active');
            
            // Reset audio mode
            uploadBtn.classList.remove('hidden');
            uploadSection.classList.remove('has-song');
            songInfo.classList.remove('active');
            uploadSection.style.display = 'block';
            playerSection.style.display = 'block';
            
            // Reset YouTube mode
            youtubeInputContainer.classList.remove('active', 'hidden');
            youtubePlayerWrapper.classList.remove('active');
            youtubeControlsSection.classList.remove('active');
            
            // Set audio as default mode
            audioTab.classList.add('active');
            youtubeTab.classList.remove('active');
            currentMode = 'audio';
            
            // Reset chapters
            addChapterBtn.disabled = true;
            document.getElementById('youtubeAddChapterBtn').disabled = true;
            chapters = [];
            renderChapters();
            
            // Clear audio source
            audioPlayer.src = '';
            playIcon.style.display = 'block';
            pauseIcon.style.display = 'none';
            isPlaying = false;
            
            // Clear input
            youtubeInput.value = '';
            youtubePopupInput.value = '';
        }

        // Call initialize on page load
        initializeUI();

        // Mode switching
        audioTab.addEventListener('click', () => {
            switchMode('audio');
        });

        youtubeTab.addEventListener('click', () => {
            switchMode('youtube');
        });

        function switchMode(mode) {
            currentMode = mode;
            
            if (mode === 'audio') {
                audioTab.classList.add('active');
                youtubeTab.classList.remove('active');
                uploadSection.style.display = 'block';
                youtubeInputContainer.classList.remove('active');
                playerSection.style.display = 'block';
                audioChaptersSection.style.display = 'flex';
                youtubePlayerWrapper.classList.remove('active');
                youtubeControlsSection.classList.remove('active');
                youtubeUrlPopup.classList.remove('active');
                
                // Pause YouTube if playing
                if (ytPlayer && ytPlayer.getPlayerState() === 1) {
                    ytPlayer.pauseVideo();
                }
            } else {
                youtubeTab.classList.add('active');
                audioTab.classList.remove('active');
                uploadSection.style.display = 'none';
                youtubeInputContainer.classList.remove('active');
                playerSection.style.display = 'none';
                audioChaptersSection.style.display = 'none';
                
                // Show popup
                youtubeUrlPopup.classList.add('active');
                youtubePopupInput.value = '';
                youtubePopupInput.focus();
                
                // Pause audio if playing
                if (audioPlayer.src && !audioPlayer.paused) {
                    audioPlayer.pause();
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                    isPlaying = false;
                }
            }
        }

        // YouTube API Ready
        function onYouTubeIframeAPIReady() {
            console.log('YouTube API Ready');
        }

        // Extract YouTube Video ID
        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // Load YouTube Video from popup
        popupLoadBtn.addEventListener('click', loadYouTubeVideo);
        
        youtubePopupInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadYouTubeVideo();
            }
        });

        function loadYouTubeVideo() {
            const url = youtubePopupInput.value.trim();
            const videoId = extractVideoId(url);
            
            if (!videoId) {
                alert('Please enter a valid YouTube URL');
                return;
            }

            if (!ytPlayer) {
                ytPlayer = new YT.Player('youtube-player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        'playsinline': 1,
                        'controls': 1,
                        'modestbranding': 1,
                        'rel': 0
                    },
                    events: {
                        'onReady': onPlayerReady
                    }
                });
            } else {
                ytPlayer.loadVideoById(videoId);
            }
        }

        // Cancel popup
        popupCancelBtn.addEventListener('click', () => {
            youtubeUrlPopup.classList.remove('active');
            // Switch back to audio mode
            switchMode('audio');
        });

        function onPlayerReady(event) {
            document.getElementById('youtubeAddChapterBtn').disabled = false;
            
            // Hide mode selector and popup
            modeSelector.classList.add('hidden');
            youtubeUrlPopup.classList.remove('active');
            
            // Show player and controls
            youtubePlayerWrapper.classList.add('active');
            youtubeControlsSection.classList.add('active');
            
            // Generate key for YouTube video
            const videoId = ytPlayer.getVideoData().video_id;
            currentSongKey = `youtube_${videoId}`;
            loadChapters(currentSongKey);
        }

        // Local Storage for Chapters
        function saveChapters() {
            if (currentSongKey) {
                localStorage.setItem(currentSongKey, JSON.stringify(chapters));
            }
        }

        function loadChapters(songKey) {
            const saved = localStorage.getItem(songKey);
            if (saved) {
                chapters = JSON.parse(saved);
                renderChapters();
            } else {
                chapters = [];
                renderChapters();
            }
        }

        function generateSongKey(filename, duration) {
            return `${filename}_${Math.floor(duration)}`;
        }

        // Update media session (notifications)
        function updateMediaSession(title, artist, artwork) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: title,
                    artist: artist,
                    album: '',
                    artwork: artwork ? [
                        { src: artwork, sizes: '512x512', type: 'image/jpeg' }
                    ] : []
                });

                // Set up action handlers
                navigator.mediaSession.setActionHandler('play', () => {
                    audioPlayer.play();
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                    isPlaying = true;
                });

                navigator.mediaSession.setActionHandler('pause', () => {
                    audioPlayer.pause();
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                    isPlaying = false;
                });

                navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                    skip(-10);
                });

                navigator.mediaSession.setActionHandler('seekforward', (details) => {
                    skip(10);
                });

                navigator.mediaSession.setActionHandler('seekto', (details) => {
                    if (details.seekTime) {
                        audioPlayer.currentTime = details.seekTime;
                    }
                });
            }
        }

        // File upload
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                audioPlayer.src = url;
                
                // Hide mode selector and upload button, show song info
                modeSelector.classList.add('hidden');
                uploadBtn.classList.add('hidden');
                uploadSection.classList.add('has-song');
                songInfo.classList.add('active');
                addChapterBtn.disabled = false;
                
                let songTitleText = file.name.replace(/\.[^/.]+$/, "");
                let songArtistText = 'Unknown Artist';
                let artworkUrl = null;
                
                // Read ID3 tags
                jsmediatags.read(file, {
                    onSuccess: function(tag) {
                        // Set song title
                        if (tag.tags.title) {
                            songTitleText = tag.tags.title;
                            songTitle.textContent = songTitleText;
                        } else {
                            songTitle.textContent = songTitleText;
                        }
                        
                        // Set artist
                        if (tag.tags.artist) {
                            songArtistText = tag.tags.artist;
                            songArtist.textContent = songArtistText;
                        } else {
                            songArtist.textContent = songArtistText;
                        }
                        
                        // Set album art
                        if (tag.tags.picture) {
                            const picture = tag.tags.picture;
                            const base64String = btoa(
                                picture.data.reduce((data, byte) => data + String.fromCharCode(byte), '')
                            );
                            artworkUrl = `data:${picture.format};base64,${base64String}`;
                            albumArt.innerHTML = `<img src="${artworkUrl}" alt="Album Art">`;
                        } else {
                            albumArt.innerHTML = '<span class="placeholder">ðŸŽµ</span>';
                        }

                        // Update media session with metadata
                        updateMediaSession(songTitleText, songArtistText, artworkUrl);
                    },
                    onError: function(error) {
                        console.log('Error reading tags:', error);
                        // Fallback to filename
                        songTitle.textContent = songTitleText;
                        songArtist.textContent = songArtistText;
                        albumArt.innerHTML = '<span class="placeholder">ðŸŽµ</span>';
                        updateMediaSession(songTitleText, songArtistText, null);
                    }
                });
                
                // Load metadata and chapters
                audioPlayer.addEventListener('loadedmetadata', () => {
                    totalTime.textContent = formatTime(audioPlayer.duration);
                    progressBar.max = audioPlayer.duration;
                    
                    // Generate song key and load saved chapters
                    currentSongKey = generateSongKey(file.name, audioPlayer.duration);
                    loadChapters(currentSongKey);
                    
                    // Update media session in case tags weren't read
                    if (!artworkUrl) {
                        updateMediaSession(songTitleText, songArtistText, null);
                    }
                }, { once: true });
            }
        });

        // Play/Pause
        playPause.addEventListener('click', () => {
            if (audioPlayer.src) {
                if (isPlaying) {
                    audioPlayer.pause();
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                } else {
                    audioPlayer.play();
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                }
                isPlaying = !isPlaying;
            }
        });

        // Update progress
        audioPlayer.addEventListener('timeupdate', () => {
            if (!isSeeking) {
                progressBar.value = audioPlayer.currentTime;
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressBar.style.setProperty('--progress', progress + '%');
                currentTime.textContent = formatTime(audioPlayer.currentTime);
                
                // Update media session position
                if ('mediaSession' in navigator && 'setPositionState' in navigator.mediaSession) {
                    try {
                        navigator.mediaSession.setPositionState({
                            duration: audioPlayer.duration,
                            playbackRate: audioPlayer.playbackRate,
                            position: audioPlayer.currentTime
                        });
                    } catch (e) {
                        console.log('Error updating position state:', e);
                    }
                }
            }
        });

        // Slider input - for dragging
        progressBar.addEventListener('input', (e) => {
            isSeeking = true;
            const time = e.target.value;
            currentTime.textContent = formatTime(time);
            const progress = (time / audioPlayer.duration) * 100;
            progressBar.style.setProperty('--progress', progress + '%');
        });

        // Slider change - when user releases
        progressBar.addEventListener('change', (e) => {
            if (audioPlayer.src) {
                audioPlayer.currentTime = e.target.value;
                isSeeking = false;
            }
        });

        // Skip controls
        document.getElementById('back1').addEventListener('click', () => skip(-1));
        document.getElementById('skip1').addEventListener('click', () => skip(1));

        function skip(seconds) {
            if (audioPlayer.src) {
                audioPlayer.currentTime = Math.max(0, Math.min(audioPlayer.duration, audioPlayer.currentTime + seconds));
            }
        }

        // Chapters
        addChapterBtn.addEventListener('click', () => {
            let time;
            
            if (currentMode === 'audio' && audioPlayer.src && !isNaN(audioPlayer.currentTime)) {
                time = audioPlayer.currentTime;
            } else {
                return;
            }
            
            chapters.push(time);
            chapters.sort((a, b) => a - b);
            saveChapters();
            renderChapters();
        });

        // YouTube chapters
        document.getElementById('youtubeAddChapterBtn').addEventListener('click', () => {
            if (currentMode === 'youtube' && ytPlayer) {
                const time = ytPlayer.getCurrentTime();
                chapters.push(time);
                chapters.sort((a, b) => a - b);
                saveChapters();
                renderChapters();
            }
        });

        // YouTube time controls
        document.getElementById('youtubeSkip1').addEventListener('click', () => {
            if (ytPlayer) {
                const current = ytPlayer.getCurrentTime();
                const duration = ytPlayer.getDuration();
                const newTime = Math.min(duration, current + 1);
                ytPlayer.seekTo(newTime, true);
                // Ensure video continues playing after seek
                setTimeout(() => {
                    if (ytPlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                        ytPlayer.playVideo();
                    }
                }, 100);
            }
        });

        document.getElementById('youtubeBack1').addEventListener('click', () => {
            if (ytPlayer) {
                const current = ytPlayer.getCurrentTime();
                const newTime = Math.max(0, current - 1);
                ytPlayer.seekTo(newTime, true);
                // Ensure video continues playing after seek
                setTimeout(() => {
                    if (ytPlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                        ytPlayer.playVideo();
                    }
                }, 100);
            }
        });

        function renderChapters() {
            const elements = getChapterElements();
            
            if (chapters.length === 0) {
                if (currentMode === 'youtube') {
                    elements.list.innerHTML = '';
                } else {
                    elements.list.innerHTML = '<div class="empty-chapters">No chapters yet. Add a chapter at the current time!</div>';
                }
                return;
            }

            if (currentMode === 'youtube') {
                elements.list.innerHTML = chapters.map((time, index) => `
                    <button class="youtube-chapter-minimal" onclick="event.stopPropagation(); seekToChapter(${time})">
                        <span class="youtube-chapter-number-minimal">#${index + 1}</span>
                        <span>${formatTime(time)}</span>
                        <button class="youtube-chapter-delete-minimal" onclick="event.stopPropagation(); deleteChapter(event, ${index})">Ã—</button>
                    </button>
                `).join('');
            } else {
                elements.list.innerHTML = chapters.map((time, index) => `
                    <div class="chapter-item" onclick="seekToChapter(${time})">
                        <div class="chapter-number">${index + 1}</div>
                        <div class="chapter-time">${formatTime(time)}</div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteChapter(event, ${index})">Ã—</button>
                    </div>
                `).join('');
            }
        }

        window.seekToChapter = (time) => {
            if (currentMode === 'audio') {
                audioPlayer.currentTime = time;
                if (!isPlaying) {
                    audioPlayer.play();
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                    isPlaying = true;
                }
            } else if (currentMode === 'youtube' && ytPlayer) {
                ytPlayer.seekTo(time, true);
                // Ensure video plays after seeking
                setTimeout(() => {
                    const state = ytPlayer.getPlayerState();
                    if (state !== YT.PlayerState.PLAYING) {
                        ytPlayer.playVideo();
                    }
                }, 100);
            }
        };

        window.deleteChapter = (event, index) => {
            event.stopPropagation();
            chapters.splice(index, 1);
            saveChapters();
            renderChapters();
        };

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
